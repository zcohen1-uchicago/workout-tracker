<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Workout Tracker Pro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input, select, textarea { font-size: 16px !important; }
        button, a { min-height: 44px; }
        .rest-timer { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // FIXED: Use localStorage directly (works on Render, more reliable than window.storage)
        const storage = {
            get: (key) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error('Storage get error:', e);
                    return null;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error('Storage set error:', e);
                    return false;
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error('Storage remove error:', e);
                    return false;
                }
            }
        };

        const allEquipment = [
            'Barbell', 'Dumbbells', 'Kettlebells', 'Cable Machine', 'Pull-up Bar',
            'Bench', 'Squat Rack', 'Leg Press', 'Rowing Machine', 'Treadmill',
            'Battle Ropes', 'Sled', 'Box/Platform', 'Medicine Ball', 'Resistance Bands',
            'Dip Station', 'Hex Bar'
        ];

        const exercises = {
            "Barbell Deadlift-Clean-Press": { 
                equipment: ['Barbell'], 
                substitutes: ['DB Clean and Press', 'KB Clean and Press'],
                description: "Explosive full-body movement. Deadlift bar from ground, clean to shoulders, press overhead.",
                formCues: ["Flat back on deadlift", "Explosive hip drive", "Catch bar on shoulders", "Full lockout"],
                muscleGroups: ['Full Body', 'Shoulders', 'Legs']
            },
            "KB Suitcase Squats": { 
                equipment: ['Kettlebells'], 
                substitutes: ['DB Suitcase Squats', 'Goblet Squats'],
                description: "Hold kettlebell at side like suitcase. Squat keeping torso upright.",
                formCues: ["Shoulders level", "Core tight", "Squat to parallel", "Drive through heels"],
                muscleGroups: ['Legs', 'Core']
            },
            "Battle Ropes": { 
                equipment: ['Battle Ropes'], 
                substitutes: ['Jump Rope', 'High Knees'],
                description: "Create alternating waves with heavy ropes.",
                formCues: ["Athletic stance", "Rapid arms", "Maintain rhythm", "Core engaged"],
                muscleGroups: ['Cardio', 'Arms', 'Core']
            },
            "Bulgarian Split Squats": { 
                equipment: ['Bench', 'Dumbbells'], 
                substitutes: ['Lunges', 'Step-Ups'],
                description: "Rear foot elevated, front leg squats. Single-leg builder.",
                formCues: ["Front shin vertical", "Knee over toe", "Chest up", "Full depth"],
                muscleGroups: ['Legs', 'Glutes']
            },
            "Box Jumps": { 
                equipment: ['Box/Platform'], 
                substitutes: ['Jump Squats', 'Step-Ups'],
                description: "Explosive jump onto platform. Power builder.",
                formCues: ["Soft landing", "Full hip extension", "Land quietly", "Step down"],
                muscleGroups: ['Legs', 'Power']
            },
            "Goblet Squats": { 
                equipment: ['Dumbbells'], 
                substitutes: ['KB Goblet Squat', 'Front Squat'],
                description: "Hold dumbbell at chest, squat deep.",
                formCues: ["Elbows between knees", "Chest up", "Deep squat", "Knees out"],
                muscleGroups: ['Legs', 'Quads']
            },
            "Pull Ups": { 
                equipment: ['Pull-up Bar'], 
                substitutes: ['Lat Pulldown', 'Inverted Rows'],
                description: "Overhand grip, pull chin over bar.",
                formCues: ["Full hang", "Engage lats", "Chest to bar", "Control down"],
                muscleGroups: ['Back', 'Biceps']
            },
            "Barbell Flat Bench": { 
                equipment: ['Barbell', 'Bench'], 
                substitutes: ['DB Bench Press', 'Push-Ups'],
                description: "Classic barbell bench press.",
                formCues: ["Arch back", "Retract shoulders", "Bar to nipples", "Press up"],
                muscleGroups: ['Chest', 'Triceps']
            },
            "Hex Bar Deadlift": { 
                equipment: ['Hex Bar'], 
                substitutes: ['Conventional Deadlift', 'Sumo Deadlift'],
                description: "Trap bar deadlift. Quad emphasis, back-friendly.",
                formCues: ["Neutral spine", "Push floor", "Hip extension", "Controlled"],
                muscleGroups: ['Legs', 'Back']
            },
            "Romanian Deadlifts": { 
                equipment: ['Barbell'], 
                substitutes: ['DB RDLs', 'Single Leg RDLs'],
                description: "Hip hinge with slight knee bend. Hamstring focus.",
                formCues: ["Slight knee bend", "Hips back", "Hamstring stretch", "Bar close"],
                muscleGroups: ['Hamstrings', 'Glutes']
            },
            "DB Bench Press": { 
                equipment: ['Dumbbells', 'Bench'], 
                substitutes: ['Barbell Bench', 'Push-Ups'],
                description: "Dumbbell bench. Greater ROM than barbell.",
                formCues: ["Full range", "Control down", "Press up and in", "Stable"],
                muscleGroups: ['Chest', 'Triceps']
            },
            "Barbell Rows": { 
                equipment: ['Barbell'], 
                substitutes: ['DB Rows', 'Cable Rows'],
                description: "Bent over row. Back thickness.",
                formCues: ["Flat back", "Pull to chest", "Squeeze top", "Don't stand"],
                muscleGroups: ['Back', 'Biceps']
            }
        };

        const workoutPrograms = {
            cleanpress: {
                name: "Clean-Press Day",
                variations: [[
                    { name: "Barbell Deadlift-Clean-Press", sets: 4, reps: "10-12", rest: 60 },
                    { name: "KB Suitcase Squats", sets: 4, reps: "10-12", rest: 120 },
                    { name: "Battle Ropes", sets: 4, reps: "30-60 sec", rest: 60 },
                    { name: "Bulgarian Split Squats", sets: 4, reps: "10-12", rest: 60 },
                    { name: "Box Jumps", sets: 4, reps: "10-12", rest: 60 }
                ]]
            },
            squat: {
                name: "Squat Day",
                variations: [[
                    { name: "Goblet Squats", sets: 4, reps: "10-15", rest: 60 },
                    { name: "Romanian Deadlifts", sets: 4, reps: "10-12", rest: 90 },
                    { name: "Pull Ups", sets: 4, reps: "AMRAP", rest: 60 },
                    { name: "Bulgarian Split Squats", sets: 4, reps: "10-12", rest: 60 }
                ]]
            },
            deadlift: {
                name: "Deadlift Day",
                variations: [[
                    { name: "Hex Bar Deadlift", sets: 4, reps: "8-10", rest: 120 },
                    { name: "Bulgarian Split Squats", sets: 4, reps: "10-12", rest: 60 },
                    { name: "Pull Ups", sets: 4, reps: "AMRAP", rest: 60 },
                    { name: "Battle Ropes", sets: 4, reps: "30-60 sec", rest: 60 }
                ]]
            },
            bench: {
                name: "Bench/Back Day",
                variations: [[
                    { name: "Barbell Flat Bench", sets: 4, reps: "8-12", rest: 120 },
                    { name: "Pull Ups", sets: 4, reps: "AMRAP", rest: 60 },
                    { name: "DB Bench Press", sets: 4, reps: "10-12", rest: 90 },
                    { name: "Barbell Rows", sets: 4, reps: "8-10", rest: 60 }
                ]]
            },
            extra: {
                name: "Extra Day",
                variations: [[
                    { name: "Pull Ups", sets: 4, reps: "AMRAP", rest: 90 },
                    { name: "DB Bench Press", sets: 3, reps: "10-12", rest: 60 },
                    { name: "Barbell Rows", sets: 3, reps: "10-12", rest: 60 },
                    { name: "Bulgarian Split Squats", sets: 3, reps: "10-12", rest: 60 },
                    { name: "Battle Ropes", sets: 3, reps: "30-60 sec", rest: 60 }
                ]]
            }
        };

        function RestTimer({ seconds, onComplete }) {
            const [timeLeft, setTimeLeft] = useState(seconds);
            
            useEffect(() => {
                if (timeLeft <= 0) {
                    onComplete();
                    return;
                }
                const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
                return () => clearTimeout(timer);
            }, [timeLeft]);

            return (
                <div className="rest-timer bg-green-500 text-white px-6 py-4 rounded-full shadow-2xl">
                    <div className="text-center">
                        <div className="text-sm font-bold">REST</div>
                        <div className="text-3xl font-bold">{timeLeft}s</div>
                    </div>
                </div>
            );
        }

        function WorkoutTimer({ startTime }) {
            const [elapsed, setElapsed] = useState(0);

            useEffect(() => {
                const interval = setInterval(() => {
                    setElapsed(Math.floor((Date.now() - startTime) / 1000));
                }, 1000);
                return () => clearInterval(interval);
            }, [startTime]);

            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;

            return (
                <div className="bg-purple-700 text-white px-4 py-2 rounded-lg text-center">
                    <div className="text-xs font-bold">WORKOUT TIME</div>
                    <div className="text-2xl font-bold">
                        {minutes}:{seconds.toString().padStart(2, '0')}
                    </div>
                </div>
            );
        }

        function SetTimer({ onComplete, onCancel }) {
            const [seconds, setSeconds] = useState(0);
            const [isRunning, setIsRunning] = useState(false);

            useEffect(() => {
                if (!isRunning) return;
                const interval = setInterval(() => {
                    setSeconds(s => s + 1);
                }, 1000);
                return () => clearInterval(interval);
            }, [isRunning]);

            const formatTime = (secs) => {
                const mins = Math.floor(secs / 60);
                const remainingSecs = secs % 60;
                return `${mins}:${remainingSecs.toString().padStart(2, '0')}`;
            };

            return (
                <div className="fixed bottom-24 right-4 bg-blue-500 text-white px-6 py-4 rounded-2xl shadow-2xl z-50">
                    <div className="text-center">
                        <div className="text-sm font-bold">SET TIMER</div>
                        <div className="text-4xl font-bold mb-2">{formatTime(seconds)}</div>
                        <div className="flex gap-2">
                            {!isRunning ? (
                                <button 
                                    onClick={() => setIsRunning(true)}
                                    className="bg-white text-blue-500 px-4 py-2 rounded-lg font-bold text-sm">
                                    Start
                                </button>
                            ) : (
                                <button 
                                    onClick={() => setIsRunning(false)}
                                    className="bg-white text-blue-500 px-4 py-2 rounded-lg font-bold text-sm">
                                    Pause
                                </button>
                            )}
                            <button 
                                onClick={() => {
                                    setSeconds(0);
                                    setIsRunning(false);
                                }}
                                className="bg-white text-blue-500 px-4 py-2 rounded-lg font-bold text-sm">
                                Reset
                            </button>
                            <button 
                                onClick={onCancel}
                                className="bg-red-500 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                ‚úï
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function WorkoutHistory({ workouts, onDelete, onEdit, onClose }) {
            const [editingWorkout, setEditingWorkout] = useState(null);
            const [editData, setEditData] = useState(null);

            const startEdit = (workout, idx) => {
                setEditingWorkout(idx);
                setEditData(JSON.parse(JSON.stringify(workout))); // Deep clone
            };

            const saveEdit = () => {
                onEdit(editingWorkout, editData);
                setEditingWorkout(null);
                setEditData(null);
            };

            const updateEditSet = (exIdx, setIdx, field, value) => {
                setEditData(prev => {
                    const updated = JSON.parse(JSON.stringify(prev));
                    updated.exercises[exIdx].sets[setIdx][field] = value;
                    return updated;
                });
            };

            if (editingWorkout !== null && editData) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-2xl font-bold">Edit Workout</h2>
                                <button onClick={() => setEditingWorkout(null)} className="text-4xl">&times;</button>
                            </div>

                            <div className="mb-4">
                                <div className="font-bold text-lg">{editData.name}</div>
                                <div className="text-sm text-gray-600">
                                    {new Date(editData.date).toLocaleDateString()}
                                </div>
                            </div>

                            <div className="mb-4">
                                <label className="block text-sm font-bold mb-2">Notes</label>
                                <textarea 
                                    value={editData.notes || ''}
                                    onChange={(e) => setEditData({...editData, notes: e.target.value})}
                                    className="w-full border-2 rounded p-2"
                                    rows="2"
                                />
                            </div>

                            <div className="space-y-4 mb-4">
                                {editData.exercises?.map((ex, exIdx) => (
                                    <div key={exIdx} className="border rounded-lg p-4">
                                        <div className="font-bold mb-3">{ex.name}</div>
                                        <div className="space-y-2">
                                            {ex.sets?.map((set, setIdx) => (
                                                <div key={setIdx} className="grid grid-cols-3 gap-2">
                                                    <span className="font-bold text-purple-600 flex items-center">
                                                        Set {setIdx + 1}
                                                    </span>
                                                    <input 
                                                        type="number" 
                                                        value={set.weight || ''}
                                                        onChange={(e) => updateEditSet(exIdx, setIdx, 'weight', e.target.value)}
                                                        placeholder="lbs"
                                                        className="border-2 rounded px-2 py-2 text-center"
                                                    />
                                                    <input 
                                                        type="number" 
                                                        value={set.reps || ''}
                                                        onChange={(e) => updateEditSet(exIdx, setIdx, 'reps', e.target.value)}
                                                        placeholder="reps"
                                                        className="border-2 rounded px-2 py-2 text-center"
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setEditingWorkout(null)}
                                    className="flex-1 bg-gray-300 text-gray-800 font-bold py-3 rounded-xl">
                                    Cancel
                                </button>
                                <button 
                                    onClick={saveEdit}
                                    className="flex-1 bg-green-500 text-white font-bold py-3 rounded-xl">
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" onClick={onClose}>
                    <div className="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold">Workout History</h2>
                            <button onClick={onClose} className="text-4xl">&times;</button>
                        </div>
                        
                        {workouts.length === 0 ? (
                            <p className="text-center text-gray-500 py-8">No workouts yet. Complete your first workout!</p>
                        ) : (
                            <div className="space-y-3">
                                {workouts.map((workout, idx) => (
                                    <div key={idx} className="border rounded-lg p-4">
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <div className="font-bold text-lg">{workout.name}</div>
                                                <div className="text-sm text-gray-600">
                                                    {new Date(workout.date).toLocaleDateString('en-US', { 
                                                        weekday: 'short', 
                                                        month: 'short', 
                                                        day: 'numeric',
                                                        year: 'numeric'
                                                    })}
                                                </div>
                                                {workout.duration && (
                                                    <div className="text-sm text-gray-600">Duration: {workout.duration} min</div>
                                                )}
                                            </div>
                                            <div className="flex gap-2">
                                                <button 
                                                    onClick={() => startEdit(workout, idx)}
                                                    className="text-blue-500 px-3 py-1 rounded hover:bg-blue-50 text-sm font-bold">
                                                    Edit
                                                </button>
                                                <button 
                                                    onClick={() => onDelete(idx)}
                                                    className="text-red-500 px-3 py-1 rounded hover:bg-red-50 text-sm font-bold">
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                        
                                        {workout.exercises && (
                                            <div className="mt-3 space-y-2">
                                                {workout.exercises.map((ex, exIdx) => (
                                                    <div key={exIdx} className="text-sm bg-gray-50 p-2 rounded">
                                                        <div className="font-semibold">{ex.name}</div>
                                                        <div className="text-gray-600 flex gap-4 flex-wrap">
                                                            {ex.sets.map((set, setIdx) => (
                                                                set.weight && set.reps && (
                                                                    <span key={setIdx}>
                                                                        {set.weight}lbs √ó {set.reps}
                                                                    </span>
                                                                )
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        
                                        {workout.notes && (
                                            <div className="mt-2 text-sm text-gray-600 italic">
                                                Note: {workout.notes}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function ExerciseDetailModal({ exercise, previousData, onClose }) {
            const exerciseData = exercises[exercise.name];
            if (!exerciseData) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" onClick={onClose}>
                    <div className="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-start mb-4">
                            <h2 className="text-2xl font-bold text-purple-800">{exercise.name}</h2>
                            <button onClick={onClose} className="text-4xl">&times;</button>
                        </div>

                        <div className="mb-4 p-6 bg-gradient-to-br from-purple-100 to-blue-100 rounded-xl">
                            <div className="text-6xl text-center mb-2">üí™</div>
                            <div className="text-center text-sm text-gray-600">
                                {exerciseData.muscleGroups.join(' ‚Ä¢ ')}
                            </div>
                        </div>

                        {previousData && previousData.length > 0 && (
                            <div className="mb-4 p-4 bg-blue-50 rounded-lg">
                                <div className="font-bold text-blue-900 mb-2">üìä Last Time:</div>
                                <div className="flex gap-3 flex-wrap">
                                    {previousData.map((set, idx) => (
                                        set.weight && set.reps && (
                                            <span key={idx} className="bg-white px-3 py-1 rounded">
                                                {set.weight}lbs √ó {set.reps}
                                            </span>
                                        )
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="mb-4">
                            <h3 className="text-lg font-bold mb-2 text-purple-700">Description</h3>
                            <p className="text-gray-700">{exerciseData.description}</p>
                        </div>

                        <div className="mb-4">
                            <h3 className="text-lg font-bold mb-2 text-purple-700">Form Cues</h3>
                            <ul className="space-y-2">
                                {exerciseData.formCues.map((cue, i) => (
                                    <li key={i} className="flex items-start">
                                        <span className="text-green-500 text-xl mr-2">‚úì</span>
                                        <span className="text-gray-700">{cue}</span>
                                    </li>
                                ))}
                            </ul>
                        </div>

                        {exerciseData.equipment.length > 0 && (
                            <div className="mb-4">
                                <h3 className="text-lg font-bold mb-2 text-purple-700">Equipment</h3>
                                <div className="flex gap-2 flex-wrap">
                                    {exerciseData.equipment.map(eq => (
                                        <span key={eq} className="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                                            {eq}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}

                        <button 
                            onClick={onClose}
                            className="w-full bg-purple-600 text-white font-bold py-3 rounded-xl">
                            Got it!
                        </button>
                    </div>
                </div>
            );
        }

        function App() {
            const [currentDay, setCurrentDay] = useState(null);
            const [userEquipment, setUserEquipment] = useState([]);
            const [showEquipmentModal, setShowEquipmentModal] = useState(false);
            const [workoutHistory, setWorkoutHistory] = useState([]);
            const [showHistory, setShowHistory] = useState(false);
            const [currentWorkout, setCurrentWorkout] = useState(null);
            const [selectedExercise, setSelectedExercise] = useState(null);
            const [restTimer, setRestTimer] = useState(null);
            const [workoutNotes, setWorkoutNotes] = useState('');
            const [startTime, setStartTime] = useState(null);
            const [showSetTimer, setShowSetTimer] = useState(false);
            const [swappedExercises, setSwappedExercises] = useState({});

            // Load data on mount
            useEffect(() => {
                const equipment = storage.get('equipment');
                const history = storage.get('workoutHistory');
                
                if (equipment) setUserEquipment(equipment);
                if (history) setWorkoutHistory(history);
                
                console.log('Loaded equipment:', equipment);
                console.log('Loaded history:', history);
            }, []);

            const saveEquipment = () => {
                const saved = storage.set('equipment', userEquipment);
                console.log('Saving equipment:', userEquipment, 'Success:', saved);
                setShowEquipmentModal(false);
                if (saved) {
                    alert('‚úÖ Equipment saved!');
                }
            };

            const toggleEquipment = (item) => {
                setUserEquipment(prev => 
                    prev.includes(item) ? prev.filter(e => e !== item) : [...prev, item]
                );
            };

            const startWorkout = (dayKey) => {
                setCurrentDay(dayKey);
                setStartTime(Date.now());
                const program = workoutPrograms[dayKey];
                const exercises = program.variations[0].map(ex => ({
                    ...ex,
                    sets: Array(ex.sets).fill(null).map(() => ({ weight: '', reps: '', completed: false }))
                }));
                setCurrentWorkout({ exercises });
            };

            const updateSet = (exerciseIdx, setIdx, field, value) => {
                setCurrentWorkout(prev => {
                    const updated = { ...prev };
                    updated.exercises[exerciseIdx].sets[setIdx][field] = value;
                    return updated;
                });
            };

            const toggleSetComplete = (exerciseIdx, setIdx, restTime) => {
                setCurrentWorkout(prev => {
                    const updated = { ...prev };
                    const set = updated.exercises[exerciseIdx].sets[setIdx];
                    set.completed = !set.completed;
                    
                    // Start rest timer if completing the set
                    if (set.completed && restTime) {
                        setRestTimer(restTime);
                    }
                    
                    return updated;
                });
            };

            const completeWorkout = () => {
                if (!currentWorkout || !currentDay) return;

                const duration = Math.round((Date.now() - startTime) / 60000); // minutes
                
                const workout = {
                    date: new Date().toISOString(),
                    name: workoutPrograms[currentDay].name,
                    exercises: currentWorkout.exercises.map(ex => ({
                        name: ex.name,
                        sets: ex.sets
                    })),
                    duration,
                    notes: workoutNotes
                };

                const newHistory = [workout, ...workoutHistory];
                setWorkoutHistory(newHistory);
                const saved = storage.set('workoutHistory', newHistory);
                
                console.log('Saving workout:', workout, 'Success:', saved);
                
                if (saved) {
                    alert('üéâ Workout saved!');
                } else {
                    alert('‚ö†Ô∏è Could not save workout. Check browser settings.');
                }
                
                setCurrentDay(null);
                setCurrentWorkout(null);
                setWorkoutNotes('');
                setStartTime(null);
            };

            const deleteWorkout = (idx) => {
                if (confirm('Delete this workout?')) {
                    const newHistory = workoutHistory.filter((_, i) => i !== idx);
                    setWorkoutHistory(newHistory);
                    storage.set('workoutHistory', newHistory);
                }
            };

            const editWorkout = (idx, updatedWorkout) => {
                const newHistory = [...workoutHistory];
                newHistory[idx] = updatedWorkout;
                setWorkoutHistory(newHistory);
                storage.set('workoutHistory', newHistory);
            };

            const checkEquipment = (exerciseName) => {
                const exerciseData = exercises[exerciseName];
                if (!exerciseData || exerciseData.equipment.length === 0) {
                    return { hasEquipment: true, missing: [] };
                }
                const missing = exerciseData.equipment.filter(eq => !userEquipment.includes(eq));
                return { hasEquipment: missing.length === 0, missing };
            };

            const swapExercise = (exerciseName, exerciseIdx) => {
                const exerciseData = exercises[exerciseName];
                if (!exerciseData?.substitutes?.length) return;
                
                const currentSwap = swappedExercises[exerciseIdx] || exerciseName;
                const allOptions = [exerciseName, ...exerciseData.substitutes];
                const currentIndex = allOptions.indexOf(currentSwap);
                const nextIndex = (currentIndex + 1) % allOptions.length;
                
                setSwappedExercises(prev => ({
                    ...prev,
                    [exerciseIdx]: allOptions[nextIndex]
                }));

                // Update the current workout with swapped exercise
                setCurrentWorkout(prev => {
                    const updated = { ...prev };
                    const originalExercise = program.variations[0][exerciseIdx];
                    updated.exercises[exerciseIdx] = {
                        name: allOptions[nextIndex],
                        sets: Array(originalExercise.sets).fill(null).map(() => ({ 
                            weight: '', 
                            reps: '', 
                            completed: false 
                        }))
                    };
                    return updated;
                });
            };

            const getPreviousExerciseData = (exerciseName) => {
                for (let workout of workoutHistory) {
                    const ex = workout.exercises?.find(e => e.name === exerciseName);
                    if (ex && ex.sets) return ex.sets;
                }
                return null;
            };

            // Main menu
            if (!currentDay) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-purple-900 p-4">
                        <div className="max-w-2xl mx-auto">
                            <div className="text-center text-white mb-6">
                                <h1 className="text-4xl font-bold mb-2">üí™ Workout Tracker</h1>
                                <p className="text-sm opacity-90">Pro Version with History</p>
                            </div>

                            <div className="flex gap-2 mb-6">
                                <button 
                                    onClick={() => setShowEquipmentModal(true)}
                                    className="flex-1 bg-white text-purple-600 font-bold py-3 rounded-xl">
                                    ‚öôÔ∏è Equipment
                                </button>
                                <button 
                                    onClick={() => setShowHistory(true)}
                                    className="flex-1 bg-white text-purple-600 font-bold py-3 rounded-xl">
                                    üìä History
                                </button>
                            </div>

                            {showEquipmentModal && (
                                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                                    <div className="bg-white rounded-2xl p-6 max-w-xl w-full max-h-[80vh] overflow-y-auto">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-xl font-bold">My Equipment</h2>
                                            <button onClick={() => setShowEquipmentModal(false)} className="text-4xl">&times;</button>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 mb-4">
                                            {allEquipment.map(item => (
                                                <label key={item} className="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={userEquipment.includes(item)}
                                                        onChange={() => toggleEquipment(item)}
                                                        className="w-5 h-5 mr-2"
                                                    />
                                                    <span className="text-sm">{item}</span>
                                                </label>
                                            ))}
                                        </div>
                                        <button 
                                            onClick={saveEquipment}
                                            className="w-full bg-green-500 text-white font-bold py-3 rounded-xl">
                                            Save Equipment
                                        </button>
                                    </div>
                                </div>
                            )}

                            {showHistory && (
                                <WorkoutHistory 
                                    workouts={workoutHistory}
                                    onDelete={deleteWorkout}
                                    onEdit={editWorkout}
                                    onClose={() => setShowHistory(false)}
                                />
                            )}

                            <div className="bg-white rounded-2xl p-6 mb-6">
                                <h2 className="text-xl font-bold mb-4">Quick Stats</h2>
                                <div className="grid grid-cols-3 gap-3">
                                    <div className="bg-gradient-to-br from-purple-600 to-purple-800 text-white p-4 rounded-xl text-center">
                                        <div className="text-3xl font-bold">{workoutHistory.length}</div>
                                        <div className="text-xs opacity-90">Total</div>
                                    </div>
                                    <div className="bg-gradient-to-br from-purple-600 to-purple-800 text-white p-4 rounded-xl text-center">
                                        <div className="text-3xl font-bold">
                                            {workoutHistory.filter(w => {
                                                const weekAgo = new Date();
                                                weekAgo.setDate(weekAgo.getDate() - 7);
                                                return new Date(w.date) > weekAgo;
                                            }).length}
                                        </div>
                                        <div className="text-xs opacity-90">This Week</div>
                                    </div>
                                    <div className="bg-gradient-to-br from-purple-600 to-purple-800 text-white p-4 rounded-xl text-center">
                                        <div className="text-3xl font-bold">
                                            {userEquipment.length}
                                        </div>
                                        <div className="text-xs opacity-90">Equipment</div>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl p-6">
                                <h2 className="text-xl font-bold mb-4">Start Workout</h2>
                                <div className="grid grid-cols-2 gap-3">
                                    {Object.keys(workoutPrograms).map(key => (
                                        <button 
                                            key={key}
                                            onClick={() => startWorkout(key)}
                                            className={`bg-gradient-to-r from-purple-600 to-purple-800 text-white font-bold py-6 rounded-xl active:scale-95 transition ${
                                                key === 'extra' ? 'col-span-2' : ''
                                            }`}>
                                            {workoutPrograms[key].name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Workout in progress
            const program = workoutPrograms[currentDay];
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-600 to-purple-900 p-4 pb-24">
                    <div className="max-w-2xl mx-auto">
                        <button 
                            onClick={() => {
                                if (confirm('Exit workout? Progress will be lost.')) {
                                    setCurrentDay(null);
                                    setCurrentWorkout(null);
                                }
                            }}
                            className="text-white mb-4 text-lg">
                            ‚Üê Exit Workout
                        </button>

                        {selectedExercise && (
                            <ExerciseDetailModal 
                                exercise={selectedExercise}
                                previousData={getPreviousExerciseData(selectedExercise.name)}
                                onClose={() => setSelectedExercise(null)}
                            />
                        )}

                        {restTimer && (
                            <RestTimer 
                                seconds={restTimer}
                                onComplete={() => setRestTimer(null)}
                            />
                        )}

                        {showSetTimer && (
                            <SetTimer 
                                onComplete={() => setShowSetTimer(false)}
                                onCancel={() => setShowSetTimer(false)}
                            />
                        )}

                        <div className="bg-white rounded-2xl p-6">
                            <div className="flex justify-between items-center mb-2">
                                <h2 className="text-2xl font-bold">{program.name}</h2>
                                <button 
                                    onClick={() => setShowSetTimer(!showSetTimer)}
                                    className="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                    ‚è±Ô∏è Timer
                                </button>
                            </div>
                            <div className="mb-6">
                                <WorkoutTimer startTime={startTime} />
                            </div>

                            {currentWorkout.exercises.map((exercise, exIdx) => {
                                const exerciseInfo = program.variations[0][exIdx];
                                const displayName = swappedExercises[exIdx] || exercise.name;
                                const previousData = getPreviousExerciseData(displayName);
                                const equipCheck = checkEquipment(displayName);
                                
                                return (
                                    <div key={exIdx} className="bg-gray-50 rounded-xl p-5 mb-4">
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="flex-1">
                                                <h3 className="text-lg font-bold">{displayName}</h3>
                                                {!equipCheck.hasEquipment && (
                                                    <div className="text-xs text-orange-600 mt-1">
                                                        ‚ö†Ô∏è Missing: {equipCheck.missing.join(', ')}
                                                    </div>
                                                )}
                                                {previousData && (
                                                    <div className="text-xs text-blue-600 mt-1">
                                                        Last: {previousData.filter(s => s.weight && s.reps).map(s => `${s.weight}√ó${s.reps}`).join(', ')}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex gap-2 ml-2">
                                                {!equipCheck.hasEquipment && (
                                                    <button
                                                        onClick={() => swapExercise(exercise.name, exIdx)}
                                                        className="bg-orange-500 text-white px-3 py-2 rounded text-xs font-bold">
                                                        Swap
                                                    </button>
                                                )}
                                                <button
                                                    onClick={() => setSelectedExercise({...exerciseInfo, name: displayName})}
                                                    className="bg-blue-500 text-white px-3 py-2 rounded text-xs font-bold">
                                                    Info
                                                </button>
                                            </div>
                                        </div>

                                        <div className="flex gap-3 mb-4 text-xs flex-wrap">
                                            <span className="bg-white px-3 py-1 rounded">Sets: {exerciseInfo.sets}</span>
                                            <span className="bg-white px-3 py-1 rounded">Reps: {exerciseInfo.reps}</span>
                                            <span className="bg-white px-3 py-1 rounded">Rest: {exerciseInfo.rest}s</span>
                                        </div>

                                        <div className="space-y-2">
                                            {exercise.sets.map((set, setIdx) => (
                                                <div key={setIdx} className="grid grid-cols-4 gap-2">
                                                    <span className="font-bold text-purple-600 flex items-center text-sm">
                                                        {setIdx + 1}
                                                    </span>
                                                    <input 
                                                        type="number" 
                                                        placeholder="lbs"
                                                        value={set.weight}
                                                        onChange={(e) => updateSet(exIdx, setIdx, 'weight', e.target.value)}
                                                        className="border-2 rounded px-2 py-2 text-center" 
                                                    />
                                                    <input 
                                                        type="number" 
                                                        placeholder="reps"
                                                        value={set.reps}
                                                        onChange={(e) => updateSet(exIdx, setIdx, 'reps', e.target.value)}
                                                        className="border-2 rounded px-2 py-2 text-center" 
                                                    />
                                                    <button 
                                                        onClick={() => toggleSetComplete(exIdx, setIdx, exerciseInfo.rest)}
                                                        className={`rounded font-bold text-lg ${set.completed ? 'bg-green-500 text-white' : 'bg-gray-300'}`}>
                                                        ‚úì
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}

                            <div className="mb-4">
                                <label className="block text-sm font-bold mb-2">Workout Notes</label>
                                <textarea 
                                    value={workoutNotes}
                                    onChange={(e) => setWorkoutNotes(e.target.value)}
                                    placeholder="How did it feel? Any PRs?"
                                    className="w-full border-2 rounded-lg p-3"
                                    rows="3"
                                />
                            </div>

                            <button 
                                onClick={completeWorkout}
                                className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-4 rounded-xl text-lg">
                                Complete Workout
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
